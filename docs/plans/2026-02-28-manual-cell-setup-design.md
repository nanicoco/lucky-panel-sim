# デザインドキュメント: 手動セルセットアップ機能

**日付**: 2026-02-28
**対象ファイル**: `index.html`

---

## 概要

左メニューでグリッドサイズを選択した後、自動生成ではなく、ユーザーがクリック順にセルへ絵文字ペアを手動でセットできるようにする。全マスセット後はプレイフェーズへ移行し、カードの入れ替えが可能になる。

---

## 状態とデータモデル

### 状態変数

| 変数 | 型 | 説明 |
|------|-----|------|
| `phase` | `'setup'` \| `'play'` | 現在のフェーズ |
| `cells` | `(string\|null)[]` | 各セルの値（null=未セット） |
| `sequence` | `string[]` | クリック順に割り当てる絵文字の配列 |
| `nextIdx` | `number` | sequence の次に割り当てる位置 |

### シーケンス生成ロジック

```
pairCount = floor((rows × cols - 2) / 2)
sequence  = [emoji0, emoji0, emoji1, emoji1, ..., ⭐️, 😈]
           ← pairCount ペア分 →           ← 最後の2マス →
```

- 例: 3×4（12マス）→ pairCount=5 → sequence長=12
- 例: 4×5（20マス）→ pairCount=9 → sequence長=20
- 奇数マスの場合: sequence長 = totalCells-1（1マスが空のまま残る）

---

## セットアップフェーズ

### フロー

1. プリセット選択 → `phase = 'setup'`、全セル `null`、sequence生成、`nextIdx = 0`
2. 未セットのセルをクリック → `cells[i] = sequence[nextIdx++]`
3. `nextIdx >= sequence.length` になったら `phase = 'play'` へ移行

### クリック制約

- セットアップ中は既にセット済みのマスは無効（上書き不可）
- 空のマスのみクリック可能

### 視覚的フィードバック

- 未セットのマス: 空白（`.card.empty` スタイル流用）
- セット済みのマス: 絵文字を表示（通常カードスタイル）
- ヘッダー: `次: 🟧` のように次にセットされる絵文字を表示

---

## プレイフェーズ

既存の入れ替えロジックをそのまま使用:

1. 1回目クリック → `selectedIndex` をセット（ハイライト表示）
2. 2回目クリック（別のセル）→ 2マスを入れ替え、`selectedIndex = null`
3. 同じセルを再クリック → 選択解除

ヘッダーは `カードをクリックして入れ替えます` に戻す。

---

## UI変更箇所

| 箇所 | 変更前 | 変更後 |
|------|--------|--------|
| プリセットボタン | 自動でゲーム生成 | 空グリッドを展開しセットアップ開始 |
| ゲームヘッダー | 固定テキスト | フェーズに応じて動的に変化 |
| カードクリック処理 | 入れ替えのみ | フェーズで分岐（setup=セット / play=入れ替え） |

### 変更しないもの

- カードのCSS（`.card`, `.card.empty`, `.card.selected`）
- プリセットの種類・数（3×4, 4×4, 4×5, 4×6）
- リセット: プリセットボタン再クリックでセットアップ状態に戻る

---

## 採用アプローチ

**事前シーケンス生成（Approach A）**

プリセット選択時に絵文字割り当てシーケンスを配列として事前計算し、`nextIdx` をインクリメントしながら割り当てる。ロジックがシンプルで「次に何が割り当てられるか」が一目瞭然。
